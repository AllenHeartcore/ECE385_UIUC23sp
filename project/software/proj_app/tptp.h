#ifndef TPTP_H
#define TPTP_H

#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <time.h>
#include <system.h>



/* Statistics & Timing */

#define MAX_NKEY	65535
#define MAX_SCORE	10000000
#define THRES_PURE	50	// 100 ms
#define THRES_FAR	100	// 200 ms
#define THRES_LOST	200	// 400 ms
#define VALID_KEYS	"     bcdefghijklmnop rstuvwxy  234567890     -=[   ;  ,."

typedef struct {
	uint16_t time;
	int8_t key;
} note_t;

typedef struct {
	long tv_sec;
	long tv_usec;
} timeval_t;

int gametime;
timeval_t start, now;



/* Chart */

#define NKEY 1003

note_t chart[NKEY];

note_t chart_storage[NKEY] = {
	{  441, 28}, {  529, 28}, {  618, 12},
	{  706,  6}, {  706, 18}, {  794, 28}, {  882, 47}, {  971, 19}, { 1059, 31}, { 1059, 32}, { 1147, 23},
	{ 1235, 18}, { 1324, 12}, { 1324, 31}, { 1500, 21}, { 1588,  6}, { 1588, 24}, { 1676, 28}, { 1765, 31},
	{ 1765, 32}, { 1853, 21}, { 1941, 21}, { 1941, 34}, { 2029, 24}, { 2118,  6}, { 2206, 26}, { 2294,  6},
	{ 2294, 21}, { 2382,  8}, { 2471, 31}, { 2471, 32}, { 2559, 21}, { 2647, 23}, { 2735, 28}, { 2912, 21},
	{ 3000,  6}, { 3000, 18}, { 3088, 12}, { 3176, 31}, { 3176, 32}, { 3265, 28}, { 3353, 28}, { 3353, 34},
	{ 3441, 12}, { 3529,  6}, { 3529, 18}, { 3618, 28}, { 3706,  6}, { 3706, 47}, { 3794, 19}, { 3882,  6},
	{ 3971, 23}, { 4059,  6}, { 4059, 18}, { 4147, 12}, { 4235,  6}, { 4324, 21}, { 4412,  6}, { 4412, 24},
	{ 4500, 28}, { 4588,  6}, { 4676, 21}, { 4765,  6}, { 4765, 23}, { 4853, 28}, { 4941,  6}, { 4941, 24},
	{ 5029, 12}, { 5118,  6}, { 5118, 18}, { 5206, 18}, { 5294,  6}, { 5382, 19}, { 5471,  6}, { 5471, 47},
	{ 5559,  6}, { 5559, 19}, { 5735, 28}, { 5824, 19}, { 5912, 19}, { 6000, 19}, { 6088, 47}, { 6176,  5},
	{ 6176, 19}, { 6176, 25}, { 6265, 47}, { 6353,  8}, { 6353,  9}, { 6353, 14}, { 6353, 19}, { 6441, 13},
	{ 6441, 25}, { 6529, 14}, { 6529, 21}, { 6529, 32}, { 6618, 12}, { 6618, 25}, { 6662, 18}, { 6706, 14},
	{ 6706, 32}, { 6794, 25}, { 6794, 37}, { 6838, 38}, { 6882, 21}, { 6882, 32}, { 6882, 39}, { 6926, 45},
	{ 6971, 18}, { 6971, 25}, { 7059, 32}, { 7147, 18}, { 7147, 25}, { 7235, 18}, { 7235, 21}, { 7235, 32},
	{ 7324, 13}, { 7324, 25}, { 7412, 32}, { 7500, 13}, { 7500, 25}, { 7588, 13}, { 7588, 21}, { 7588, 32},
	{ 7676, 12}, { 7676, 25}, { 7765, 14}, { 7765, 32}, { 7853, 13}, { 7853, 25}, { 7941, 14}, { 7941, 21},
	{ 7941, 32}, { 8029, 12}, { 8029, 25}, { 8074, 18}, { 8118, 14}, { 8118, 32}, { 8206, 25}, { 8206, 37},
	{ 8250, 38}, { 8294, 21}, { 8294, 32}, { 8294, 39}, { 8338, 45}, { 8382, 18}, { 8382, 25}, { 8471, 32},
	{ 8559, 18}, { 8559, 25}, { 8647, 18}, { 8647, 21}, { 8647, 32}, { 8735, 13}, { 8735, 25}, { 8824, 32},
	{ 8912, 13}, { 8912, 25}, { 9000, 13}, { 9000, 21}, { 9000, 32}, { 9088, 23}, { 9088, 24}, { 9132, 12},
	{ 9132, 21}, { 9176,  8}, { 9176,  9}, { 9176, 14}, { 9176, 19}, { 9265, 13}, { 9265, 25}, { 9353, 14},
	{ 9353, 21}, { 9353, 32}, { 9441, 12}, { 9441, 25}, { 9485, 18}, { 9529, 14}, { 9529, 32}, { 9618, 25},
	{ 9618, 37}, { 9662, 38}, { 9706, 21}, { 9706, 32}, { 9706, 39}, { 9750, 45}, { 9794, 18}, { 9794, 25},
	{ 9882, 32}, { 9971, 18}, { 9971, 25}, {10059, 18}, {10059, 21}, {10059, 32}, {10147, 13}, {10147, 25},
	{10235, 32}, {10324, 13}, {10324, 25}, {10412, 13}, {10412, 21}, {10412, 32}, {10500, 12}, {10500, 25},
	{10588, 14}, {10588, 32}, {10676, 13}, {10676, 25}, {10765, 14}, {10765, 21}, {10765, 32}, {10853, 12},
	{10853, 25}, {10897, 18}, {10941, 14}, {10941, 32}, {11029, 25}, {11029, 37}, {11074, 38}, {11118, 21},
	{11118, 32}, {11118, 39}, {11162, 45}, {11206,  6}, {11206, 12}, {11206, 18}, {11206, 24}, {11206, 25},
	{11206, 27}, {11471,  7}, {11471,  9}, {11471, 13}, {11471, 14}, {11471, 15}, {11471, 22}, {11647,  8},
	{11647, 16}, {11647, 21}, {11647, 26}, {11647, 54}, {11647, 55}, {12000, 10}, {12000, 12}, {12000, 17},
	{12176, 10}, {12265, 28}, {12353, 10}, {12353, 28}, {12529, 10}, {12618, 21}, {12706, 10}, {12706, 28},
	{12882, 10}, {12882, 21}, {13059, 10}, {13059, 28}, {13235, 10}, {13235, 47}, {13412,  5}, {13412,  9},
	{13412, 47}, {13588,  9}, {13676, 19}, {13765,  9}, {13941,  9}, {14118,  6}, {14118, 22}, {14294, 22},
	{14382, 21}, {14471, 12}, {14471, 22}, {14603, 18}, {14647, 22}, {14735, 19}, {14735, 22}, {14779, 22},
	{14824,  7}, {14824, 18}, {14824, 25}, {15000,  7}, {15000, 12}, {15176,  7}, {15176, 18}, {15353,  7},
	{15353, 47}, {15529,  5}, {15529,  9}, {15529, 45}, {15706,  9}, {15706, 18}, {15882,  9}, {15882, 12},
	{16059,  9}, {16059, 24}, {16235,  6}, {16235, 22}, {16235, 24}, {16412, 22}, {16500, 28}, {16588, 12},
	{16588, 22}, {16765, 21}, {16765, 22}, {16853, 47}, {16941,  7}, {16941, 25}, {17029,  7}, {17029, 19},
	{17029, 25}, {17118,  7}, {17118, 25}, {17118, 47}, {17206,  7}, {17206, 12}, {17206, 25}, {17294,  7},
	{17338, 25}, {17382,  7}, {17382, 21}, {17426, 25}, {17471,  7}, {17471, 28}, {17515, 25}, {17559,  7},
	{17603, 25}, {17647,  8}, {17647, 12}, {17647, 16}, {17647, 26}, {17735, 27}, {17824, 32}, {17824, 33},
	{17912,  5}, {17912, 27}, {17912, 28}, {18000,  5}, {18000,  8}, {18000, 26}, {18000, 28}, {18088, 27},
	{18176, 32}, {18176, 33}, {18265,  6}, {18265, 21}, {18265, 27}, {18353,  5}, {18353,  8}, {18353, 26},
	{18353, 28}, {18441, 27}, {18529,  6}, {18529, 21}, {18529, 32}, {18529, 33}, {18618, 27}, {18706,  5},
	{18706,  8}, {18706, 26}, {18706, 28}, {18794, 27}, {18882, 32}, {18882, 33}, {18882, 47}, {18882, 55},
	{18971, 27}, {19059, 23}, {19059, 28}, {19059, 47}, {19059, 55}, {19147, 17}, {19235, 35}, {19235, 36},
	{19324, 17}, {19324, 46}, {19324, 55}, {19412, 19}, {19412, 23}, {19412, 28}, {19412, 55}, {19500, 17},
	{19588, 35}, {19588, 36}, {19676, 17}, {19765,  8}, {19765, 21}, {19853, 25}, {19941, 33}, {19941, 34},
	{20029, 25}, {20118,  8}, {20118, 12}, {20118, 16}, {20118, 21}, {20206, 25}, {20294, 19}, {20294, 33},
	{20294, 34}, {20294, 55}, {20382, 25}, {20471, 21}, {20471, 23}, {20471, 47}, {20471, 55}, {20559,  5},
	{20647, 18}, {20647, 34}, {20647, 35}, {20647, 54}, {20735,  5}, {20824, 12}, {20824, 16}, {20824, 21},
	{20824, 23}, {20912,  5}, {21000, 17}, {21000, 24}, {21000, 34}, {21000, 35}, {21088,  5}, {21176,  5},
	{21176,  8}, {21176, 26}, {21176, 28}, {21265, 27}, {21353, 23}, {21353, 25}, {21353, 32}, {21353, 33},
	{21441, 27}, {21529,  6}, {21529,  8}, {21529, 21}, {21529, 26}, {21618, 27}, {21706, 32}, {21706, 33},
	{21794, 23}, {21794, 25}, {21794, 27}, {21882,  8}, {21882, 23}, {21882, 25}, {21882, 26}, {21971, 27},
	{22059, 32}, {22059, 33}, {22147,  5}, {22147, 27}, {22147, 28}, {22235,  5}, {22235, 28}, {22235, 32},
	{22235, 33}, {22324,  8}, {22324, 21}, {22412,  7}, {22412,  9}, {22500,  6}, {22500, 25}, {22676, 33},
	{22676, 54}, {22765, 16}, {22765, 34}, {22853, 17}, {22853, 35}, {22941,  5}, {22941, 36}, {23029, 25},
	{23029, 37}, {23118,  9}, {23118, 12}, {23206, 14}, {23206, 21}, {23294, 33}, {23294, 54}, {23382, 19},
	{23382, 22}, {23471, 25}, {23471, 37}, {23559, 33}, {23559, 54}, {23735, 11}, {23735, 28}, {23824, 25},
	{23824, 37}, {23912, 33}, {23912, 54}, {24088, 19}, {24088, 22}, {24176, 25}, {24176, 37}, {24265, 33},
	{24265, 54}, {24441,  5}, {24441, 36}, {24529, 25}, {24529, 37}, {24618, 33}, {24618, 54}, {24794, 25},
	{24794, 37}, {24882, 16}, {24882, 34}, {24971, 33}, {24971, 54}, {25147, 14}, {25147, 21}, {25235,  9},
	{25235, 12}, {25324, 25}, {25324, 37}, {25500,  9}, {25500, 12}, {25588, 14}, {25588, 21}, {25676, 33},
	{25676, 54}, {25853, 32}, {25853, 33}, {25853, 54}, {25853, 55}, {25941,  8}, {25941, 14}, {25941, 15},
	{25941, 21}, {26029,  7}, {26029,  9}, {26029, 12}, {26029, 18}, {26118,  6}, {26118, 25}, {26118, 37},
	{26118, 38}, {26206,  7}, {26206, 18}, {26206, 19}, {26206, 22}, {26294, 16}, {26294, 33}, {26294, 34},
	{26294, 54}, {26382,  6}, {26382, 25}, {26382, 37}, {26382, 38}, {26559, 11}, {26559, 13}, {26559, 23},
	{26559, 28}, {26647, 16}, {26647, 33}, {26647, 34}, {26647, 54}, {26735,  6}, {26735, 25}, {26735, 37},
	{26735, 38}, {26912,  7}, {26912, 18}, {26912, 19}, {26912, 22}, {27000, 16}, {27000, 33}, {27000, 34},
	{27000, 54}, {27088,  6}, {27088, 25}, {27088, 37}, {27088, 38}, {27265, 10}, {27265, 24}, {27353, 13},
	{27353, 23}, {27441, 17}, {27441, 35}, {27618, 16}, {27618, 34}, {27706, 33}, {27706, 54}, {27794,  8},
	{27794, 15}, {27882,  7}, {27882, 18}, {27971,  6}, {27971, 38}, {28059, 25}, {28059, 37}, {28147,  5},
	{28147, 36}, {28500, 35}, {28500, 37}, {28588, 34}, {28588, 38}, {28676, 18}, {28676, 21}, {28765,  7},
	{28765, 15}, {28853, 27}, {28853, 55}, {28941, 22}, {28941, 31}, {28941, 32}, {28941, 45}, {28941, 46},
	{28941, 51}, {29118, 45}, {29118, 51}, {29206, 32}, {29206, 51}, {29294,  6}, {29382, 13}, {29382, 32},
	{29471, 13}, {29471, 45}, {29559,  7}, {29559, 13}, {29559, 23}, {29559, 31}, {29559, 37}, {29735,  7},
	{29735, 11}, {29735, 23}, {29735, 31}, {29735, 37}, {29912, 10}, {29912, 32}, {30000,  6}, {30000, 11},
	{30088, 10}, {30088, 32}, {30176, 23}, {30176, 45}, {30265, 10}, {30265, 32}, {30353, 11}, {30353, 22},
	{30353, 23}, {30353, 34}, {30353, 36}, {30529, 15}, {30529, 45}, {30618, 15}, {30618, 32}, {30706,  6},
	{30794, 23}, {30794, 32}, {30882, 23}, {30882, 45}, {30971, 22}, {30971, 23}, {30971, 32}, {30971, 34},
	{30971, 36}, {31147,  7}, {31235, 10}, {31235, 22}, {31235, 32}, {31235, 34}, {31235, 36}, {31412,  6},
	{31412, 10}, {31500, 23}, {31500, 32}, {31588, 10}, {31588, 45}, {31676, 11}, {31676, 32}, {31765,  7},
	{31765, 10}, {31765, 13}, {31765, 35}, {31765, 37}, {31941, 45}, {31941, 51}, {32029, 51}, {32029, 54},
	{32118,  6}, {32206, 13}, {32206, 54}, {32294, 13}, {32294, 45}, {32382,  8}, {32382, 13}, {32382, 23},
	{32382, 36}, {32559,  8}, {32559, 11}, {32559, 23}, {32559, 36}, {32735, 36}, {32735, 54}, {32824,  6},
	{32824, 22}, {32912, 36}, {32912, 54}, {33000, 22}, {33000, 45}, {33088, 23}, {33088, 54}, {33176, 22},
	{33176, 23}, {33176, 32}, {33176, 34}, {33176, 36}, {33265, 10}, {33353, 23}, {33353, 45}, {33441, 22},
	{33441, 54}, {33529,  6}, {33618, 22}, {33618, 54}, {33706,  7}, {33706, 45}, {33794,  9}, {33794, 11},
	{33794, 22}, {33794, 34}, {33794, 36}, {33971, 13}, {34059,  9}, {34059, 13}, {34059, 22}, {34059, 34},
	{34059, 36}, {34235, 17}, {34235, 34}, {34324, 13}, {34324, 23}, {34412, 10}, {34412, 12}, {34500,  5},
	{34500, 38}, {34588, 11}, {34588, 14}, {34588, 23}, {34588, 51}, {34765,  6}, {34765, 45}, {34853, 32},
	{34853, 54}, {35029,  6}, {35029, 45}, {35118, 32}, {35118, 54}, {35206,  9}, {35206, 12}, {35206, 28},
	{35206, 51}, {35382,  9}, {35382, 12}, {35382, 15}, {35382, 28}, {35559, 16}, {35559, 23}, {35647, 17},
	{35647, 28}, {35735,  5}, {35735, 24}, {35824, 12}, {35824, 25}, {35912,  6}, {35912, 18}, {36000,  7},
	{36000, 10}, {36000, 13}, {36000, 15}, {36088, 27}, {36088, 39}, {36176,  7}, {36176, 10}, {36265, 33},
	{36265, 55}, {36353,  7}, {36353, 10}, {36353, 13}, {36353, 15}, {36441,  6}, {36441, 38}, {36529, 10},
	{36529, 13}, {36529, 15}, {36529, 46}, {36618, 34}, {36618, 54}, {36706, 11}, {36706, 18}, {36706, 47},
	{36794, 25}, {36794, 37}, {36882, 11}, {36882, 18}, {36882, 51}, {36971, 16}, {36971, 35}, {37059, 11},
	{37059, 14}, {37059, 19}, {37147,  5}, {37147, 36}, {37235, 11}, {37235, 18}, {37235, 51}, {37323, 17},
	{37323, 36}, {37412, 31}, {37412, 55}, {37500,  9}, {37500, 14}, {37588, 27}, {37588, 46}, {37676,  9},
	{37676, 14}, {37765, 32}, {37765, 54}, {37853, 10}, {37853, 13}, {37941,  6}, {37941, 45}, {38029,  8},
	{38029, 12}, {38029, 19}, {38029, 23}, {38206, 10}, {38294, 19}, {38382, 19}, {38471, 19}, {38559, 51},
	{38647, 19}, {38647, 28}, {38647, 34}, {38735, 51}, {38823,  8}, {38823,  9}, {38823, 14}, {38823, 19},
	{38912, 13}, {38912, 25}, {39000, 14}, {39000, 21}, {39000, 32}, {39088, 12}, {39088, 25}, {39132, 18},
	{39176, 14}, {39176, 32}, {39265, 25}, {39265, 37}, {39309, 38}, {39353, 21}, {39353, 32}, {39353, 39},
	{39397, 45}, {39441,  5}, {39441, 13}, {39441, 18}, {39529, 33}, {39618,  5}, {39618, 18}, {39706, 18},
	{39706, 23}, {39706, 33}, {39794,  6}, {39794, 13}, {39794, 23}, {39882, 31}, {39971,  6}, {39971, 13},
	{40059,  8}, {40059, 13}, {40059, 31}, {40147,  9}, {40147, 10}, {40147, 12}, {40235,  5}, {40235, 14},
	{40235, 32}, {40323,  6}, {40323, 13}, {40412, 14}, {40412, 21}, {40412, 32}, {40500, 12}, {40500, 25},
	{40544, 18}, {40588, 14}, {40588, 32}, {40676, 25}, {40676, 37}, {40721, 38}, {40765, 21}, {40765, 32},
	{40765, 39}, {40809, 45}, {40853,  5}, {40853, 13}, {40853, 18}, {40941, 33}, {41029,  5}, {41029, 18},
	{41118, 18}, {41118, 23}, {41118, 33}, {41206,  6}, {41206, 13}, {41206, 23}, {41294, 31}, {41382,  6},
	{41382, 13}, {41471,  8}, {41471, 13}, {41471, 31}, {41559, 10}, {41559, 11}, {41603, 16}, {41603, 21},
	{41647,  9}, {41647, 14}, {41647, 17}, {41647, 28}, {41735, 13}, {41735, 25}, {41823, 14}, {41823, 21},
	{41823, 32}, {41912, 12}, {41912, 25}, {41956, 18}, {42000, 14}, {42000, 32}, {42088, 25}, {42088, 37},
	{42132, 38}, {42176, 21}, {42176, 32}, {42176, 39}, {42221, 45}, {42265,  5}, {42265, 13}, {42265, 18},
	{42353, 33}, {42441,  5}, {42441, 18}, {42529, 18}, {42529, 23}, {42529, 33}, {42618,  6}, {42618, 13},
	{42618, 23}, {42706, 31}, {42794,  6}, {42794, 13}, {42882,  8}, {42882, 13}, {42882, 31}, {42970,  9},
	{42970, 10}, {42970, 12}, {43059,  5}, {43059, 14}, {43059, 32}, {43147,  6}, {43147, 13}, {43235, 14},
	{43235, 21}, {43235, 32}, {43323, 12}, {43323, 25}, {43368, 18}, {43412, 14}, {43412, 32}, {43500, 25},
	{43500, 37}, {43544, 38}, {43588, 21}, {43588, 32}, {43588, 39}, {43632, 45}, {43676,  5}, {43676, 13},
	{43676, 18}, {43765, 33}, {43853,  5}, {43853, 18}, {43941, 18}, {43941, 23}, {43941, 33}, {44029,  6},
	{44029, 13}, {44029, 23}, {44118, 31}, {44206,  6}, {44206, 13}, {44294,  8}, {44294, 13}, {44294, 31},
	{44382,  8}, {44382, 12}, {44382, 18}, {44382, 19}, {44382, 21}, {44382, 23}, {44382, 26}, {44382, 47}};



/* Scorekeeper */

#define GST_IDLE    0x00
#define GST_CONFIG  0x04
#define GST_PLAY    0x08
#define GST_REPORT  0x0C

#define DLIFE_TICK  1
#define DLIFE_PURE  12
#define DLIFE_FAR   6
#define DLIFE_LOST  -8
#define DLIFE_BOOST 75
#define LIFE_MAX    255
#define LIFE_MIN    0

#define DSKILL_PURE 24
#define DSKILL_FAR  12
#define DSKILL_TICK -8
#define SKILL_MAX   255
#define SKILL_MIN   1
#define SCORE_BOOST_FIG0 0.2
#define SCORE_BOOST_FIG2 0.3

char valid_keys[64] = VALID_KEYS;
note_t touches[MAX_NKEY] = {0};

int nmpure, npure, nfar, nlost, ntouch;
int score, score_base, score_boost;
int combo, maxcombo, nkey, tnkey;
float acc, tacc;

uint8_t gst_state = GST_IDLE, gst_fig = 0;
int16_t life, skill; // odd = OFF, even = ON



/* VGA Register Programming */

#define COLOR_TOUCH 0
#define COLOR_LOST  1
#define COLOR_FAR   2
#define COLOR_PURE  3
#define LARGEST     7
#define BRIGHTEST   7
#define PHASE_IDLE  0
#define PHASE_ENTER 1
#define PHASE_EXIT  2

#define NREG            64
#define KEYCODE_MIN     5
#define KEYCODE_MAX     55
#define KEYCODE_FLG     48
#define KEYCODE_LFE     49
#define KEYCODE_SKL     50
#define KEYCODE_SDRAM_ADDR  40
#define KEYCODE_SDRAM_DATA  43

#define FLGMASK_PLY     0x10

#define KEYCODE_ENTER   40
#define KEYCODE_ESC     41
#define KEYCODE_LEFT    80
#define KEYCODE_RIGHT   79
#define KEYCODE_SPACE   44

typedef struct {
	uint8_t nsize;
	uint8_t color;
	uint8_t brght;
	uint8_t phase;
	int timestamp;
} keystat_t;

int sdram_addr, sdram_addr_prev;
keystat_t keystats[NREG];
static volatile alt_u8* game_ctrl  = (alt_u8*)GAME_BASE;
static volatile alt_u8* sdram_base = (alt_u8*)SDRAM_BASE;



/* Misc Utils */

#define ASSERT(stmt, msg)		\
do {							\
	if (!(stmt)) {				\
		printf("%s\n", (msg));	\
		exit(1);				\
	}							\
} while (0)

#define ROUND(num) (int)((num) + 0.5)

#define LOG(time, msg, key) \
	printf("[Time %5d | Score %08d, Accuracy %5.2f%% | Pure %4d, Far %4d, Lost %4d, Combo %4d, Life %3d, Skill %3d] %s %c\n", \
	(time), score, acc * 100, nmpure + npure, nfar, nlost, combo, life, skill, (msg), (key));


#endif
